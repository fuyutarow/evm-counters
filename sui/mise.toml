[tools]
node = "24.8.0"
bun = "1.2.22"

[vars]
default_network = "testnet"
default_package = "counter"
gas_budget = "100000000"

[tasks.install]
description = "Install dependencies"
alias = "i"
run = "bun install"

[tasks.dev]
description = "Start development server"
alias = "d"
run = "bun run dev"

[tasks.build]
description = "Build the project"
alias = "b"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ“¦ Building project..."
echo ""
echo "Step 1: Generating types..."
mise run codegen
echo ""
echo "Step 2: Building Next.js app..."
bun run build
echo ""
echo "âœ… Build complete!"
'''

# ===========================
# ğŸ” LINT (ãƒã‚§ãƒƒã‚¯ã®ã¿)
# ===========================

[tasks.lint]
description = "Run all linters (Biome + ESLint + TypeScript)"
alias = "l"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ” Running all linters..."
echo ""
echo "Step 1: Biome check..."
bunx biome check .
echo "âœ… Biome passed"
echo ""
echo "Step 2: ESLint check..."
npx eslint . --ext .ts,.tsx --max-warnings 0
echo "âœ… ESLint passed"
echo ""
echo "Step 3: TypeScript check..."
bunx tsc --noEmit
echo "âœ… TypeScript passed"
echo ""
echo "ğŸ‰ All checks passed!"
'''

[tasks.lint-biome]
description = "Run Biome check only"
alias = "lb"
run = "bunx biome check ."

[tasks.lint-eslint]
description = "Run ESLint check only"
alias = "le"
run = "npx eslint . --ext .ts,.tsx --max-warnings 0"

[tasks.lint-types]
description = "Run TypeScript check only"
alias = "lt"
run = "bunx tsc --noEmit"

[tasks.typecheck]
description = "Run TypeScript type checking"
alias = "tc"
run = "bunx tsc --noEmit"

# ===========================
# ğŸ”§ FIX (è‡ªå‹•ä¿®æ­£)
# ===========================

[tasks.fix]
description = "Fix all auto-fixable issues (Biome unsafe + ESLint) + TypeScript check"
alias = "f"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ”§ Fixing all auto-fixable issues..."
echo ""
echo "Step 1: Biome unsafe fix..."
bunx biome check --write --unsafe .
echo "âœ… Biome unsafe fixed"
echo ""
echo "Step 2: ESLint fix..."
npx eslint src --ext .ts,.tsx --fix || true
echo "âœ… ESLint fixed"
echo ""
echo "Step 3: TypeScript check..."
bunx tsc --noEmit
echo "âœ… TypeScript passed"
echo ""
echo "ğŸ‰ All fixable issues resolved!"
'''

[tasks.fix-biome]
description = "Fix with Biome only"
alias = "fb"
run = "bunx biome check --write ."

[tasks.fix-eslint]
description = "Fix with ESLint only"
alias = "fe"
run = "npx eslint src --ext .ts,.tsx --fix"

[tasks.fix-unsafe]
description = "Fix with Biome unsafe mode (aggressive)"
alias = "fu"
run = "bunx biome check --write --unsafe ."

[tasks.clean]
description = "Clean all build artifacts and caches"
alias = "c"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ§¹ Cleaning all build artifacts..."
rip .next || true
rip .next-dev || true
rip tsconfig.tsbuildinfo || true
rip .serena || true
rip dist || true
rip **/build || true
echo "âœ… All cleaned!"
'''

[tasks.preview]
description = "Preview built app"
alias = "p"
run = "bun run preview"

[tasks.up]
description = "Update dependencies to latest versions"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ“¦ Checking for outdated packages..."
bunx npm-check-updates
echo ""
echo "ğŸ“¦ Updating package.json to latest versions..."
bunx npm-check-updates -u
echo ""
echo "ğŸ“¦ Installing updated dependencies..."
npm install
echo "âœ… Dependencies updated to latest versions!"
'''

[tasks.faucet-testnet]
description = "Open Sui testnet faucet in browser"
alias = "faucet"
run = "open https://faucet.sui.io/?network=testnet"

[tasks.faucet-devnet]
description = "Request SUI tokens from devnet faucet via API"
alias = "faucet-dev"
run = '''
#!/usr/bin/env bash
set -euo pipefail
# Get active address from sui client
ADDRESS=$(sui client active-address 2>/dev/null || echo "")
if [ -z "$ADDRESS" ]; then
    echo "âŒ No active Sui address found. Run 'sui client' to set up your wallet."
    exit 1
fi
echo "ğŸš€ Requesting SUI tokens for address: $ADDRESS"
echo "ğŸ“¡ Calling devnet faucet API..."
curl --location --request POST 'https://faucet.devnet.sui.io/v2/gas' \
    --header 'Content-Type: application/json' \
    --data-raw "{
        \"FixedAmountRequest\": {
            \"recipient\": \"$ADDRESS\"
        }
    }"
echo ""
echo "âœ… Faucet request completed!"
'''

[tasks.sui-setup]
description = "æŒ‡å®šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã«Sui CLIè¨­å®š | å¼•æ•°: [NETWORK] (default: testnet)"
alias = "sui-env"
run = '''
#!/usr/bin/env bash
set -euo pipefail
NETWORK="${1:-testnet}"
echo "ğŸ”§ Setting up Sui CLI for $NETWORK..."
sui client switch --env $NETWORK || sui client new-env --alias $NETWORK --rpc https://fullnode.$NETWORK.sui.io:443
echo "âœ… Switched to $NETWORK"
sui client active-env
'''

# å¼•æ•°: [NETWORK] (default: testnet)
# æ©Ÿèƒ½: æŒ‡å®šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã®Sui CLIè¨­å®š
# å¯¾å¿œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: testnet, devnet, mainnet
#
# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:
# 1. ç’°å¢ƒç¢ºèª: sui client active-env
# 2. ã‚¬ã‚¹æ®‹é‡ç¢ºèª: sui client gas
# 3. ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª: sui client active-address

[tasks.sui-setup-devnet]
description = "Set up Sui CLI for devnet"
alias = "sui-dev"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸ”§ Setting up Sui CLI for devnet..."
sui client new-env --alias devnet --rpc https://fullnode.devnet.sui.io:443 || true
sui client switch --env devnet
echo "âœ… Switched to devnet"
sui client active-env
'''

[tasks.sui-build]
description = "Build Move contract"
alias = "move-build"
run = '''
#!/usr/bin/env bash
set -euo pipefail
PACKAGE="${1:-counter}"
echo "ğŸ“¦ Building $PACKAGE..."
cd move/$PACKAGE && sui move build
'''

[tasks.sui-publish]
description = "Publish Move contract"
alias = "move-publish"
run = '''
#!/usr/bin/env bash
set -euo pipefail
PACKAGE="${1:-counter}"
NETWORK="${2:-testnet}"

echo "ğŸ“¦ Publishing $PACKAGE to $NETWORK..."
mise run sui-setup $NETWORK
cd move/$PACKAGE
sui client publish --gas-budget {{vars.gas_budget}}

echo ""
echo "ğŸ”„ Next steps:"
echo "  1. Manually update suigen-config.json with the Package ID"
echo "  2. mise run gen    # Update ABI definitions"
echo "  3. mise run dev    # Restart development server"
'''

[tasks.deploy]
description = "å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤: ç’°å¢ƒè¨­å®šâ†’faucetâ†’ãƒ“ãƒ«ãƒ‰â†’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ | å¼•æ•°: [PACKAGE] [NETWORK]"
alias = "d"
run = '''
#!/usr/bin/env bash
set -euo pipefail  # ã‚¨ãƒ©ãƒ¼æ™‚å³åº§åœæ­¢ã€æœªå®šç¾©å¤‰æ•°ã‚¨ãƒ©ãƒ¼ã€ãƒ‘ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼æ¤œå‡º
PACKAGE="${1:-counter}"  # ç¬¬1å¼•æ•° (default: counter)
NETWORK="${2:-testnet}"  # ç¬¬2å¼•æ•° (default: testnet)

echo "ğŸš€ Starting complete $NETWORK deployment for $PACKAGE..."
echo ""
echo "Step 1: Setting up $NETWORK..."
# Sui CLIã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’æŒ‡å®šã•ã‚ŒãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«åˆ‡ã‚Šæ›¿ãˆ
mise run sui-setup $NETWORK
echo ""
echo "Step 2: Getting SUI tokens..."
# faucetã‹ã‚‰ã‚¬ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆnetworkã«å¿œã˜ã¦è‡ªå‹•é¸æŠï¼‰
mise run faucet-$NETWORK 2>/dev/null || mise run faucet
echo ""
echo "Step 3: Building $PACKAGE..."
# Moveãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
mise run sui-build $PACKAGE
echo ""
echo "Step 4: Publishing $PACKAGE to $NETWORK..."
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
mise run sui-publish $PACKAGE $NETWORK
echo ""
echo "ğŸ‰ Deployment complete!"
'''

# å¼•æ•°: [PACKAGE] [NETWORK] (default: counter testnet)
# æ©Ÿèƒ½: ç’°å¢ƒè¨­å®šã‹ã‚‰ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ã¾ã§ã®å®Œå…¨è‡ªå‹•åŒ–
# å«ã¾ã‚Œã‚‹å‡¦ç†:
# 1. Sui CLIç’°å¢ƒè¨­å®š (mise run sui-setup)
# 2. faucetã‹ã‚‰ã‚¬ã‚¹å–å¾— (mise run faucet-*)
# 3. Moveå¥‘ç´„ãƒ“ãƒ«ãƒ‰ (mise run sui-build)
# 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ (mise run sui-publish)
#
# ä½¿ç”¨ä¾‹:
# mise run deploy counter testnet    # testnetã«counterã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
# mise run deploy-devnet             # devnetã«counterã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ä½œæ¥­:
# 1. suigen-config.jsonã«Package IDã‚’æ‰‹å‹•ã§æ›´æ–°
# 2. mise run codegen  # ABIå‹å®šç¾©ã®å†ç”Ÿæˆ
# 3. mise run dev      # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•

[tasks.deploy-devnet]
description = "Complete deployment to devnet (setup, faucet, build, publish)"
alias = "deploy-dev"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "ğŸš€ Starting complete devnet deployment..."
echo ""
echo "Step 1: Setting up devnet..."
mise run sui-setup-devnet
echo ""
echo "Step 2: Getting SUI tokens..."
mise run faucet-devnet
echo ""
echo "Step 3: Building contract..."
mise run sui-build
echo ""
echo "Step 4: Publishing contract..."
mise run sui-publish
echo ""
echo "ğŸ‰ Deployment complete!"
'''

[tasks.move-format]
run = '''
bunx @mysten/prettier-plugin-move --use-module-label=true -w move/**/*.move
'''


[tasks.test]
description = "Run all tests with Bun"
alias = "t"
run = "bun test"

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# watch ãƒ¢ãƒ¼ãƒ‰: mise run test-watch

[tasks.test-watch]
description = "Run tests in watch mode"
alias = "tw"
run = "bun test --watch"

[tasks.codegen-abi]
description = "Generate Sui ABI definitions from .deployed-packages.json"
alias = ["gen-abi", "abigen"]
run = "bun scripts/suigenv0.ts --config suigen-config.json --network testnet --output src/abi"


[tasks.codegen]
description = "Sui ABIå‹å®šç¾©ã‚’ç”Ÿæˆ | å‰æ: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã€suigen-config.jsonè¨­å®šæ¸ˆã¿"
alias = "gen"
run = '''
#!/usr/bin/env bash
set -euo pipefail  # ã‚¨ãƒ©ãƒ¼æ™‚å³åº§åœæ­¢ã€æœªå®šç¾©å¤‰æ•°ã‚¨ãƒ©ãƒ¼ã€ãƒ‘ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼æ¤œå‡º
echo "ğŸ—ï¸  Generating types..."
echo ""
echo "Generating Sui ABI definitions..."
# suigen-config.jsonã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸IDã‚’èª­ã¿è¾¼ã¿ã€TypeScriptå‹å®šç¾©ã‚’ç”Ÿæˆ
bun scripts/suigenv0.ts --config suigen-config.json --network testnet --output src/abi
echo ""
echo "âœ… Types generated successfully!"
'''

# å‰ææ¡ä»¶: Moveå¥‘ç´„ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã€suigen-config.jsonè¨­å®šæ¸ˆã¿
# æ©Ÿèƒ½: Sui GraphQL APIã‹ã‚‰å‹å®‰å…¨ãªTypeScriptå®šç¾©ã‚’ç”Ÿæˆ
# å‡ºåŠ›: src/abi/*.ts
# ä½¿ç”¨æ™‚æœŸ: å¥‘ç´„ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€å‹å®šç¾©ãŒå¿…è¦ãªæ™‚
#
# ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦:
# 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: cat suigen-config.json
# 2. æ‰‹å‹•å‹ç”Ÿæˆ: bun scripts/suigenv0.ts --config suigen-config.json --network testnet --output src/abi

